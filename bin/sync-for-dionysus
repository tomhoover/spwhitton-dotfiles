#!/bin/sh

. "$HOME/.shenv"

athena_cmd () {
    # here we rely on the fact that ssh already passes argument
    # through `/bin/sh -c' (note use of single-quotes in this
    # function)
    # local dir=$1
    # local cmd=$2
    ssh athena 'cd $HOME/'"$1"' && . $HOME/.shenv && '"$2"
}

if [ "$(hostname -f)" = "athena.silentflame.com" ]; then
    cd "$HOME/doc"
    mr sync
    cd "$HOME/lib/dionysus"
    git annex merge
else
    # try to sync nickflash first
    cd /media/swhitton/SPWHITTON/doc 2>/dev/null && git annex add && git annex sync --content || true
    cd "$HOME/lib/dionysus" && git annex add && git annex sync --content athena
    # try to sync nickflash again
    cd /media/swhitton/SPWHITTON/doc 2>/dev/null && git annex sync --content && kill-ssh-and-umount /media/swhitton/SPWHITTON || true
    athena_cmd lib/dionysus "git annex merge"

    athena_cmd doc "mr sync"
    cd "$HOME/doc"
    mr sync
    athena_cmd doc "mr sync"
fi
