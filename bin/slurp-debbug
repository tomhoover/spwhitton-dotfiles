#!/bin/sh

# slurp messages from a Debian bug into your notmuch database

set -e

DEST="$HOME/.fmail/inbox"

bug="$1"

if [ "$1" = "" ]; then
   echo >&2 "need a bug number"
   exit 1
fi

# see https://bugs.debian.org/904182
bts --mbox show "$bug"

temp="$(mktemp -d)"
mkdir $temp/new $temp/cur $temp/tmp

# original mb2md thinks Debian BTS mboxes contain just a single
# message
mb2md-dkg "${XDG_CACHE_HOME:-$HOME/.cache}"/devscripts/bts/"$bug".mbox \
          "$temp"

for f in $temp/*/*; do
    echo "D: considering $f"
    message_id="$(grep -E -i -m 1 -e '^Message-ID:' $f | cut -d\  -f2 | sed -e 's/<//' -e 's/>//')"
    echo "D: looking for message with ID $message_id"
    match="$(notmuch search --limit=1 id:$message_id | wc -l)"
    echo "D: notmuch emitted $match lines"
    if [ "$match" = "0" ]; then
        mdmv "$f" "$DEST"
    fi
done

rm -rf "$temp"

notmuch new
