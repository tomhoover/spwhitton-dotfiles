#!/bin/bash

# Update all remote-tracking branches, and as many local branches that
# we can fast-forward.  Additionally, if the current branch looks like
# a dgit suite-tracking branch, merge the current contents of the
# Debian archive into the current branch

set -e

function branch_prefix() {
    local branch="$1"
    echo $branch | cut -s -d/ -f1
}

function branch_remote() {
    local branch="$1"
    git config branch.$branch.remote
}

current_branch="$(git rev-parse --abbrev-ref HEAD)"
branches="$(git for-each-ref --format='%(refname:short)' refs/heads/)"

if [ "$(branch_prefix $current_branch)" = "dgit" ]; then
    echo "I: current branch is $current_branch; doing \`dgit pull\`"
    dgit pull
fi
for suite in $(git show-ref | grep refs/remotes/dgit/dgit | cut -d/ -f5 ); do
    # skip if we just called `dgit pull` on this suite
    if ! [ "$current_branch" = "dgit/$suite" ]; then
        echo "I: fetching dgit suite $suite"
        dgit fetch $suite
    fi
done

git remote update
for branch in $branches; do
    remote="$(branch_remote $branch 2>/dev/null || true)"
    # echo "I: branch $branch has prefix $prefix and remote $remote"
    if [ "$(branch_prefix $branch)" != "dgit"  ] && [ "$remote" != "" ]; then
        # if the branch cannot be fast-forwarded, git-merge-ff will
        # exit non-zero, so myrepos will report that the update
        # failed, so user intervention is required
        git merge-ff "$branch"
    fi
done
