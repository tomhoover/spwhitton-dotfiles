#!/bin/bash

. $HOME/.shenv
. $HOME/lib/tputfs.sh

set -e

OUTPUT=$HOME/lib/annex/doc/mail
INPUT=$HOME/.fmail

# set the archive suffix ourselves because we don't want the archive
# ending with -jan-2014 to be added to after the end of January, so
# that it may be safely archived into the annex
suffix=$(date +-%b-%Y | sed 's/\(.*\)/\L\1/')

# safety check to be sure we don't overwrite anything

if [ -e "$OUTPUT/archive${suffix}.gz" ] || [ -e "$OUTPUT/sent${suffix}.gz" ]; then
    echo "archivemail-ma: looks like you've already made an archive recently" >&2
    echo "archivemail-ma: to avoid issues with git-annex, wait until next month"
    exit 1
fi

# now do the archiving run

archivemail \
    --days=31 \
    --output-dir=$OUTPUT \
    --preserve-unread \
    --archive-name=archive${suffix} \
    $INPUT/inbox

archivemail \
    --days=31 \
    --output-dir=$OUTPUT \
    --preserve-unread \
    --archive-name=sent${suffix} \
    $INPUT/sent

cd $OUTPUT
git annex add archive${suffix}.gz sent${suffix}.gz

status now please commit and sync ~/lib/annex
