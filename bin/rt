#!/bin/bash
. $HOME/.shenv

# first check that there exist the dirs we need

if [ ! -e "$HOME/local/rt/watch" -o ! -d "$HOME/local/rt/session" -o ! -d "$HOME/local/rt/incomplete" -o ! -e "$HOME/local/rt/complete" ]; then
    echo "I was asked to start rtorrent, but one of the dirs in ~/local/rt is missing" >&2
    exit 1
fi

# start rtorrent under dtach if it's not running

if ! pgrep -u $LOGNAME rtorrent >/dev/null; then
    rm -f $HOME/local/rt/session/dtach.socket
    TERM=xterm nice -n 19 dtach -n $HOME/local/rt/session/dtach.socket rtorrent
fi

# if we're not at a dumb terminal (so this script can be shoved in a
# crontab), try to attach what we (maybe) just made

# this is a bashism
if [ -t 1 ]; then
    dtach -a $HOME/local/rt/session/dtach.socket
fi
