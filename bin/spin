#!/bin/bash

# Sean's wrapper around propellor --spin

cd $HOME/src/propellor

branch="$(git rev-parse --abbrev-ref HEAD)"
if [ ! "$branch" = "spwconf" ]; then
    echo "wrong branch"
    exit 1
fi

# revert to system ghc
version="$(ghc --version | awk 'NF{print $NF; exit}')"
if [ ! "$version" = "7.6.3" ]; then
   PATH=/usr/bin:$PATH
   export PATH
fi

# This check from <http://unix.stackexchange.com/a/155077>
if output=$(git status --porcelain) && [ -z "$output" ]; then
    if [ -z "$1" ]; then
        propellor --spin $(hostname --fqdn)
    else
        # If there's no dots in the host we've specified, it's one of
        # my hosts, so append the rest of the domain.
        if [ -z "${1//[^.]/}" ]; then
            propellor --spin ${1}.silentflame.com
        else
            propellor --spin $1
        fi
    fi
else
    echo "commit first!"
    exit 1
fi
