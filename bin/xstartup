#!/bin/sh
. $HOME/.shenv

# stuff to start in XFCE or GNOME3

# ---- keyboard settings

setxkbmap -option ctrl:nocaps
setxkbmap -option "compose:ralt"
setxkbmap -layout gb
xbindkeys

# set US layout if my US usb keyboard is plugged in :(
lsusb | grep -q "Chicony Electronics Co., Ltd" \
    && setxkbmap -layout us

# disable built-in laptop keyboard if US usb keyboard plugged in :)
[ "$(hostname -s)" = "artemis" ] \
    && laptopinput --maybe-disable

# settings for (currently out of action) Apple USB keyboard

if lsusb | grep -q "Aluminum Keyboard"; then
    echo 2 | sudo tee /sys/module/hid_apple/parameters/fnmode > /dev/null
    xmodmap $HOME/.Xmodmap-Apple
    xset r rate 300
    sleep 2
    pkill zenity
fi

# ---- GTK settings

# Note that at least some of these won't take effect until logging in
# again to restart services.

# Have the GNOME keyring daemon cache our GPG key passphrase for no
# more than 5 minutes.  Cache time cannot be controlled for SSH keys
gsettings set org.gnome.crypto.cache gpg-cache-ttl 300
gsettings set org.gnome.crypto.cache gpg-cache-method 'timeout'

# ---- clear SSH keys out of gnome-keyring-daemon when idle (per GNOME
# ---- bug #525574 it can't do this itself yet)

pkill -u $USER idlesshclear
idlesshclear &

# ---- other stuff to launch

redshift-gtk -l 53.57:1.5 -t 6500:3700 &

# ---- fire up my window manager

# XMonad.Layout.OnHost looks at $HOST which doesn't seem to be
# available in this environment

HOST=$(cat /etc/hostname) xmonad --replace
