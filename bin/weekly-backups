#!/bin/sh

# the idea is that if this script dies it can be safely be re-run from the beginning

. "$HOME/.shenv"
. "$HOME/lib/try.sh"
. "$HOME/lib/tputfs.sh"

if ! mount | grep -q bkupsd && ! mount | grep -q m3; then
    echo >&2 "$(basename $0): plug in and mount a cold backup drive"
    exit 1
fi

cd "$HOME"

zero ls "$HOME/tmp"
zero ls /tmp/debuild
zero ssh athena ls tmp
mount "$HOME/lib/fm" || true
zero ls "$HOME/lib/fm/tmp"

# TODO: write a file to ~/.cache and if that file was edited today, skip these
ssh athena df -h
ssh athena uptime
status Press enter to confirm that athena has enough free disc space
status and it has not been unexpectedly rebooted recently
status Or hit C-c and deal with the situation
read _

try ssh -t athena "sudo apt-get update && sudo apt-get upgrade"

status running src-unregistered check
status unregistered repos need to have 'mr register' run in them
status "(and tracking branches set up, and new alioth repos added to coldbkup script)"
status periodically remove old projects from ~/src
zero src-unregistered

# status "running restow operation: failures indicate symlinks replaced by updated files"
# status "move these into the relevant stow'd repository"
zero mr -ms misstowed --delete-unmodified # use 'mr adopt' on the result
try mr -ms restow

try mr -ms autoci
# `mr -ms isclean` checks for stuff to be checked in ...
try mr -ms isclean
try mr -s up
try mr -s push origin --tags :
# ... then `mr -ms status` finds unpushed branches
zero mr -ms status
try coldbkup

try sudo apt-get update
try sudo apt-get upgrade
try sudo apt-get dist-upgrade
try sudo apt-get autoremove
try git-pbuilder update --override-config

zero check-mailqs
